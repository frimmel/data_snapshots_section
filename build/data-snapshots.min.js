/*! Data Snapshots
 * Copyright 2014 University of North Carolina at Asheville
 * Released under the MIT license
 */
!function(a){function b(a,b,c){var d=Drupal.settings.data_snapshots.patterns[a];return d.replace(/\{dsmn\}/g,a).replace(/\{ptk\}/g,b).replace(/\{stk\}/g,c)}function c(a,b,c,d){var e;a=a.replace(/_/g,""),window.history&&window.history.replaceState&&(e=null!==c?a+"-"+b+"-"+c+"?theme="+d:a+"-"+b+"?theme="+d,window.history.replaceState({},"",e))}function d(d,e,f){a(".field-name-field-ds-disimg img").attr("src",b(d,e,f)),a("div.dss-title").text(e+" / "+f),c(d,e,f,a("#dss-theme-dropdown").val())}function e(b){a(".field-name-title h2").text(b),document.title=b}function f(b){a(".group-footer").html(b)}function g(b){var c=a(b).find("ul");a(".field-name-field-ds-dloads ul").replaceWith(c)}function h(b){a(".field-name-data-snapshot-permalink .field-items .field-item").text(b)}function i(b){a(".field-name-field-ds-dtgen").replaceWith(b)}function j(b){var c,d,e,f=/(\/node\/)(\d+)(\/\w+)/,g="$1"+b+"$3",h=a(".tabs .primary a");for(e=0;e<h.length;e++)c=a(h[e]),d=c.attr("href").replace(f,g),c.attr("href",d)}function k(b){var c={Annual:{ptk:"Year:",stk:""},Monthly:{ptk:"Year:",stk:"Month:"},Weekly:{ptk:"Year:",stk:"Day:"},Custom:{ptk:"Date:",stk:""}};a(".dss-interactive-ptk-label").text(c[b].ptk),a(".dss-interactive-stk-label").text(c[b].stk)}function l(b,c,d,e){var f,g;"ptk"===b?(f=a("#dss-interactive-slider-ptk-start-label"),g=a("#dss-interactive-slider-ptk-end-label")):"stk"===b&&(f=a("#dss-interactive-slider-stk-start-label"),g=a("#dss-interactive-slider-stk-end-label")),"stk"===b&&"Annual"===e&&(c="",d=""),f.text(c),g.text(d)}function m(b,c,d,e,f){var g,h,i=6,j=a(b),k=f*(a(d).width()/(e-1))+"px";j.text(c),g=j.width()/2,h=-g+i+"px",j.css("margin-left",h).css("left",k)}function n(a,b,c,d,e,f,g){var h=b;"Annual"!==d&&(h+="-"+c),m(a,h,e,f,g)}function o(){var b,c,d=Drupal.settings.data_snapshots,e=d.snapshots.dsmn,f=d.themes,g=d.data_sources,h=a("#dss-theme-dropdown"),i=a("#dss-data-source-dropdown"),j=d.init_theme,k=!1;if(j&&-1!==f.indexOf(j)&&g[j].length>0)for(c=0;c<g[j].length;c++)g[j][c].mname===e&&(k=!0);for(c=0;c<f.length;c++)if(b=f[c],0!==g[b].length&&(h.append(a("<option>",{value:b}).text(b)),!k)){var l;for(l=0;l<g[b].length;l++)g[b][l].mname===e&&(j=b,k=!0)}for(c=0;c<g[j].length;c++)i.append(a("<option>",{value:g[j][c].mname}).text(g[j][c].oname));h.val(j),i.val(e)}function p(b){var c=250,d=c+3;return b=a("<div/>").html(b).text(),b.length>d&&(b=b.substring(0,c).trim()+"..."),b}function q(b){var c=p(b.field_dssds_framing_question.und[0].safe_value),d=p(b.field_dssds_framing_q_answer.und[0].value),e=p(b.field_dssds_secondary_questi.und[0].value),f=p(b.field_dssds_secondary_q_answ.und[0].safe_value),g=a(".field-name-field-ds-dsds-evergreen"),h=g.find(".field_dssds_framing_question"),i=g.find(".field_dssds_framing_q_answer p"),j=g.find(".field_dssds_secondary_questi"),k=g.find(".field_dssds_secondary_q_answ p"),l=g.find(".dss-question-read-more a");h.text(c),i.text(d),j.text(e),k.text(f),l.attr("href","/node/"+b.nid)}function r(a){e(a.title_html),f(a.body_html),g(a.download_html),h(a.permalink_html),i(a.date_html),j(a.nid),t=null}function s(b,c,d){var e={type:"data_snapshot",dsmn:b,ptk:c};null!==d&&(e.stk=d),t&&t.abort(),t=a.ajax({type:"POST",url:"/data-snapshots/ajax",data:e,success:r})}Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){if(void 0===this||null===this)throw new TypeError('"this" is null or not defined');var c=this.length>>>0;for(b=+b||0,1/0===Math.abs(b)&&(b=0),0>b&&(b+=c,0>b&&(b=0));c>b;b++)if(this[b]===a)return b;return-1}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});var t;a("document").ready(function(){function b(){a(".group-footer").html("").stop(!0,!0).animate({opacity:0},200).html("")}function e(){a(".group-footer").stop(!0,!0).animate({opacity:1},200)}function f(){var c="#dss-interactive-slider-ptk-popup";a("#dss-interactive-slider-ptk-slider").slider({min:0,max:x.length-1,value:y,change:function(a,b){y=b.value,z=Drupal.settings.data_snapshots.snapshots.s[x[y]],d(v,x[y],z[A]),g()},slide:function(a,b){var e,f,g,h=Drupal.settings.data_snapshots,i=h.frequencies[v];y=b.value,e=x[y],z=h.snapshots.s[e],g=z[z.length-1],f=A>=z.length?g:z[A],d(v,e,f),l("stk",z[0],g,i),n(c,e,f,i,this,x.length,y)},start:function(d,e){n(c,x[y],z[A],Drupal.settings.data_snapshots.frequencies[v],this,x.length,e.value),a(c).addClass("dss-interactive-slider-popup-active"),b()},stop:function(){a(c).removeClass("dss-interactive-slider-popup-active"),s(v,x[y],z[A]),e()}}),l("ptk",x[0],x[x.length-1],Drupal.settings.data_snapshots.frequencies[v])}function g(){var c="#dss-interactive-slider-stk-popup";a("#dss-interactive-slider-stk-slider").slider({min:0,max:z.length-1,value:A,change:function(a,b){A=b.value,d(v,x[y],z[A])},slide:function(a,b){var e,f;A=b.value,e=x[y],f=z[A],d(v,e,f),m(c,e+"-"+f,this,z.length,A)},start:function(d,e){m(c,x[y]+"-"+z[A],this,z.length,e.value),a(c).addClass("dss-interactive-slider-popup-active"),b()},stop:function(){a(c).removeClass("dss-interactive-slider-popup-active"),s(v,x[y],z[A]),e()}}),l("stk",z[0],z[z.length-1],Drupal.settings.data_snapshots.frequencies[v])}function h(){var b,c=Drupal.settings.data_snapshots.frequencies,d=["Annual"],e=a("#dss-interactive-slider-stk-slider");b=-1!==d.indexOf(c[v])?!0:!1,e.slider("option","disabled",b)}function i(){var b,d,e,f=a(this).val(),g=Drupal.settings.data_snapshots.data_sources[f],h=a("#dss-data-source-dropdown"),i=!0;for(h.empty(),e=0;e<g.length;e++)b=g[e],d=b.mname,h.append(a("<option>",{value:d}).text(b.oname)),v===d&&(h.val(d),i=!1);i===!0&&r(g[0].mname),c(v,x[y],z[A],f)}function j(){r(a(this).val())}function p(a){var b,c,e=a.dates;Drupal.settings.data_snapshots.snapshots=e,y=e.p.indexOf(a.ptk),A=e.s[a.ptk].indexOf(a.stk),x=e.p,b=x[y],z=e.s[b],c=z[A],v=e.dsmn,d(v,b,c),f(),g(),q(a.node),s(v,b,c),h(),k(Drupal.settings.data_snapshots.frequencies[v])}function r(b){var c=Drupal.settings.data_snapshots.frequencies;a.ajax({type:"POST",url:"/data-snapshots/ajax",success:p,data:{type:"data_source",current_dsmn:v,new_dsmn:b,current_frequency:c[v],new_frequency:c[b],ptk:x[y],stk:z[A]}})}var t=Drupal.settings.data_snapshots,u=t.snapshots,v=u.dsmn,w=u.init_ptk,x=u.p,y=x.indexOf(w),z=u.s[x[y]],A=u.s[w].indexOf(u.init_stk);f(),g(),o(),h(),a("#dss-data-source-dropdown").change(j),a("#dss-theme-dropdown").change(i),k(t.frequencies[v])})}(jQuery);